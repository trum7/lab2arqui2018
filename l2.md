<p align="center">
  <img src="./images/UN.png" width="200">
</p>
<h2 align="center"><small>Laboratory #2</small></br> <big>Distributed Architectures, Part 2</big></h2>

<h5 align="center">Jeisson Andrés Vergara Vargas</br><small>Software Architecture</br>2018-I</small></h5>

---

# Pre-requisitos
Para la realización de este laboratorio es necesario tener los microservicios del caso de estudio realizados en el laboratorio #1, los cuales son:
- Students: sa_students_ms, puerto 3000.
- Courses: courses-ms, puerto 4040.

- Grades: grades-ms, puerto 5000
  * student_id: Integer
  * course_id: Integer
  * grade_value: float


# Graphql

Se procedera a la implementación de graphql en cada uno de los microservicios:

## sa_students_ms

### Queries

1. Agregar la siguiente gema al archivo **Gemfile** del microservicio de students:

         gem 'graphql', '1.7.4'
         gem 'graphiql-rails'
         gem 'sass-rails'
         gem 'uglifier'
         gem 'coffee-rails'

2. Ejecutar los siguientes comandos:

  > `bundle update`
  > `rails generate graphql:install`

3. Crear un nuevo archivo en **app/graphql/types/** llamado student_type.rb y agregue el siguiente contenido:


        Types::StudentType = GraphQL::ObjectType.define do

          name 'Student'

          field :id, !types.ID
          field :name, !types.String
          field :lastname, !types.String
          field :email, !types.String
          field :code, !types.Int
          field :telephone, !types.Int

        end


4. Modificar el archivo **app/graphql/types/** llamado query_type.rb por el siguiente contenido:

        Types::QueryType = GraphQL::ObjectType.define do
          name 'Query'

          # queries are just represented as fields
          field :allStudents, !types[Types::StudentType] do
            # resolve would be called in order to fetch data for that field
            resolve -> (obj, args, ctx) { Student.all }
          end
        end

5. Ingresar al archivo **config/application.rb** y descomentar la siguiente linea, en caso de no estar se debe agregar:

        require "sprockets/railtie"


6. Agregar la siguiente linea al archivo **config/routes.rb**

        mount GraphiQL::Rails::Engine, at: "/graphiql", graphql_path: "/graphql"

5. Desplegar la aplicación en el nodo correspondiente

6. Ingresar a la dirección http://192.168.99.101:3000/graphiql donde se podra observar el IDE de graphql para realizar pruebas de las peticiones.

7. Si se realizar clic en **Docs  > query** se podra observar los queries definidos anteriormente, donde se especifica los tipos de datos que posee el objeto para ser consultados:

        {
          allStudents{
            id
            name
            code
          }
        }


![alt text](./images/image1.png "Consult")

De esta manera se pueden especificar los atributos que son necesarios para una consulta determinada.

### Mutations

8. El proceso de crear una mutacion es parecido al de crear una consulta, para esto debemos crear un archivo en la carpeta **app/graphql/mutations** llamado **mutation_type.rb**

9. Agregar el siguiente codigo al archivo generado:

        Types::MutationType = GraphQL::ObjectType.define do
          name 'Mutation'


          field :testField, types.String do
            description "An example field added by the generator"
            resolve ->(obj, args, ctx) {
              "Hello World!"
            }
          end
        end

10. La mutacion es agregada automaticamente al archivo **app/graphql/sa_students_ms_schema.rb**

        SaStudentsMsSchema = GraphQL::Schema.define do
          mutation(Types::MutationType)
          query(Types::QueryType)
        end


11. Crear un nuevo archivo en **app/graphql/resolvers/** llamado create_student.rb, si no existe la carpeta debe ser creada.


12. Agregar el siguiente codigo al archivo creado:

        class Resolvers::CreateStudent < GraphQL::Function
          
          argument :name, !types.String
          argument :lastname, !types.String
          argument :email, !types.String
          argument :code, !types.Int
          argument :telephone, !types.Int
        
          
          type Types::StudentType
        
          def call(_obj, args, _ctx)
            Student.create!(
              name: args[:name],
              lastname: args[:lastname],
              email: args[:email],
              code: args[:code],
              telephone: args[:telephone],
            )
          end
        end

13. Modificar el archivo **app/graphql/mutations/mutation_type.rb** de tal manera que quede de la siguiente forma:

        Types::MutationType = GraphQL::ObjectType.define do
          name 'Mutation'

          field :createStudent, function: Resolvers::CreateStudent.new
        end

14. Tambien se debe modificar el archivo **app/graphql/types/mutation_type.rb** de tal manera que quede de la siguiente forma:

        Types::MutationType = GraphQL::ObjectType.define do
          name 'Mutation'

          field :createStudent, function: Resolvers::CreateStudent.new
        end

14. Desplegar nuevamente el microservicio



15. Realizar la siguiente peticion en el IDE de la dirección 192.168.99.101:3000/graphiql

        mutation{
          createStudent(
              name: "Richard",
              lastname: "Herrera",
              email: "roherrerap@unal.edu.co",
              code: 1234,
              telephone: 4321,
          ){
            id
            code
          }
        }

![alt text](./images/image2.png "Mutation")